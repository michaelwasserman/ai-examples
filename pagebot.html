<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InSite AI - Pagebot Chat Assistant</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
        .ai-chat-widget button{border:none;background:0;cursor:pointer;padding:0;font-family:inherit;color:inherit}
        #ai-chat-button{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:#4285f4;color:#fff;box-shadow:0 2px 10px #0003;display:flex;justify-content:center;align-items:center;font-size:24px;z-index:9999;transition:all .3s ease;transform:rotate(180deg)}
        #ai-chat-button:hover{background:#3367d6;transform:scale(1.5)rotate(0deg)}
        #ai-chat-container{position:fixed;bottom:20px;right:20px;width:350px;height:500px;background:#fff;border-radius:10px;box-shadow:0 4px 20px #0003;border:1px solid #e0e0e0;display:none;flex-direction:column;z-index:9999;overflow:hidden}
        #ai-chat-header{background:#4285f4;color:#fff;padding:12px 15px;font-weight:700;display:flex;justify-content:space-between;align-items:center; border-bottom: 1px solid #e0e0e0;}
        .header-controls{display:flex;align-items:center;gap:10px}
        .language-selector{display:flex;align-items:center;background-color:rgba(255,255,255,.1);border-radius:15px;padding:2px 8px;color:#fff}
        #language-select{background:0 0;border:none;color:#fff;font-weight:700;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer}
        #language-select:focus{outline:0}
        #language-select option{background:#4285f4;color:#fff}
        #ai-chat-close{font-size:20px;opacity:.8;transition:opacity .3s ease}
        #ai-chat-close:hover{opacity:1}
        #ai-chat-messages{flex:1;padding:15px;overflow-y:auto;background:#f9f9f9}
        .ai-chat-message{margin-bottom:15px;padding:10px 15px;border-radius:18px;max-width:80%;word-wrap:break-word;line-height:1.4}
        .user-message{background:#4285f4;color:#fff;margin-left:auto;border-bottom-right-radius:5px}
        .ai-message{background:#e3f2fd;color:#000;margin-right:auto;border-bottom-left-radius:5px}
        .ai-message a{color:#3367d6;font-weight:600;text-decoration:underline;cursor:pointer}
        .ai-message a:hover{text-decoration:none}
        #ai-chat-input-container{display:flex;align-items:center;padding:10px;background:#fff;border-top:1px solid #e0e0e0}
        #ai-chat-input{flex:1;padding:10px 15px;border:1px solid #e0e0e0;border-radius:20px;outline:0;font-size:14px;transition:border-color .3s ease}
        #ai-chat-input:focus{border-color:#4285f4}
        #ai-chat-send{font-size:20px;padding:8px 15px;border-radius:20px;transition:background-color .3s ease;text-align:center;margin-left:10px;background:#4285f4;color:#fff}
        #ai-chat-send:hover{background:#3367d6}
        .typing-indicator{display:flex;align-items:center;padding:10px 0;margin-bottom:15px}
        .typing-dot{width:8px;height:8px;margin:0 2px;background:#999;border-radius:50%;animation:typing-bounce 1.4s infinite ease-in-out both}
        .typing-dot:nth-child(1){animation-delay:-.32s}
        .typing-dot:nth-child(2){animation-delay:-.16s}
        @keyframes typing-bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    </style>
</head>
<body>
    <pre>
    # InSite AI Pagebot - A Floating AI Chat Assistant for Any Website! (<a href="https://github.com/michaelwasserman/ai-examples">Github</a>)

    InSite AI Pagebot is a simple AI chat assistant example using Chrome's Built-In AI APIs, which run on-device models.

    It's a simple drop-in on-device chat bot that can answer questions about a website, summarize page content, and translate responses.
        * Answers user questions about the page using the <a target="_blank" href="https://github.com/webmachinelearning/prompt-api">Prompt API</a>. (Experimental in Chrome 138+)
        * Summarizes the page content using the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Summarizer_API">Summarizer API</a> (Available in Chrome 138+)
        * Translates responses using the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Translator_and_Language_Detector_APIs">Translator API</a> (Available in Chrome 138+)
        * Implemented with generated and tailored plain HTML/JS/CSS, using on-device translation and language models.

    Version history:
        * The <a href="https://lmarena.ai/c/442cde63-32b7-46bf-be3d-dae668144711">initial code</a> was generated by <a href="https://mistral.ai">mistral-medium-2505</a> on <a href="https://lmarena.ai">lmarena.ai</a> using this initial prompt:
            Make a button that can be shown on the corner of any website. When clicked, it opens a chat mole with a helpful AI agent.
            The chat mole has a text field where users can submit questions about the site, which are answered by Chrome's Built-In LanguageModel (aka Prompt) API, which has been prepopulated with context about the page and overall site and any user context.
            There's also a button users can easily click in the chat mole to "summarize this page" which provides a short 1-2 sentence summary of the page derived from on-page text the overall site and user context.
            * The initial reponse included: `Here's a complete implementation for a floating chat button that opens an AI assistant powered by Chrome's built-in LanguageModel API. This solution includes the button, chat interface, and functionality to summarize pages, and change the assistant's response language.`
        * Minimal functionality was implemented with about 10 lines of code changes in about 10 minutes - <a href="https://michaelwasserman.github.io/ai-examples/lmarena_chatbot_1a.html">try it here</a>.
        * An alternative initial demo can be tested <a href="https://michaelwasserman.github.io/ai-examples/lmarena_chatbot_1b.html">here</a>
        * Followup refinements made by <a href="https://github.com/michaelwasserman">michaelwasserman</a>'s artisinal keyboard clacking and <a href="https://gemini.google.com/">Gemini</a> include:
            * Adding response translation using the Translation API
            * Adding predefined help prompt links
            * Refactoring for api usage improvements, clarity, and brevity
    </pre>

    <div class="ai-chat-widget">
        <!-- Chat button -->
        <button id="ai-chat-button">‚ÄΩ</button>

        <!-- Chat container -->
        <div id="ai-chat-container">
            <div id="ai-chat-header">
                <span>InSite AI</span>
                 <div class="header-controls">
                    <div class="language-selector">
                        üåê&nbsp;<select id="language-select"></select>
                    </div>
                    <button id="ai-chat-close">‚úï</button>
                </div>
            </div>

            <div id="ai-chat-messages">
                <!-- Messages will appear here -->
            </div>

            <div id="ai-chat-input-container">
                <input type="text" id="ai-chat-input" placeholder="Ask me about this page...">
                <button id="ai-chat-send">‚Ü£</button>
            </div>
        </div>
    </div>

    <script>
        const chatButton = document.getElementById('ai-chat-button');
        const chatContainer = document.getElementById('ai-chat-container');
        const chatClose = document.getElementById('ai-chat-close');
        const chatMessages = document.getElementById('ai-chat-messages');
        const chatInput = document.getElementById('ai-chat-input');
        const chatSend = document.getElementById('ai-chat-send');
        const languageSelect = document.getElementById('language-select');

        let languageModel = undefined;
        let translator = undefined;
        let summarizer = undefined;

        if (!'LanguageModel' in self) {
            console.warn("Chrome's LanguageModel API is not available in this browser.");
        }

        chatButton.addEventListener('click', async () => {
            if ('LanguageModel' in self) {
              const pageContent = await getPageContent();
              const initialPrompt = `You are a helpful AI assistant for this website. Here's some context about the page:\n\n${pageContent}\n\n
                                     Please provide helpful responses to user prompts based on the page content and context, making the answer as concise as possible, 3 sentences or fewer.`;
              LanguageModel.create({initialPrompts: [{role: 'system', content: initialPrompt}]}).then((lm) => { languageModel = lm; });
            }
            chatContainer.style.display = 'flex';
            chatButton.style.display = 'none';
            chatInput.focus();
        });

        chatClose.addEventListener('click', () => {
            chatContainer.style.display = 'none';
            chatButton.style.display = 'block';
        });

        chatSend.addEventListener('click', (e) => { sendMessage() });
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        // From https://crsrc.org/c/chrome/browser/on_device_translation/language_pack_util.h
        const languages = ['EN', 'ES', 'JA', 'AR', 'BN', 'DE', 'FR', 'HI', 'IT', 'KO', 'NL', 'PL', 'PT', 'RU', 'TH', 'TR', 'VI', 'ZH', 'BG', 'CS', 'DA', 'EL', 'FI', 'HR', 'HU', 'ID', 'IW', 'LT', 'NO', 'RO', 'SK', 'SL', 'SV', 'UK', 'KN', 'TA', 'TE', 'MR'];
        for (l of languages) { languageSelect.options.add(new Option(l, l)); }
        languageSelect.addEventListener('change', async (e) => { setLanguage(e.target.value); });

        // Event delegation for action links
        chatMessages.addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                const action = e.target.dataset.action;
                if (!action) return;
                e.preventDefault();
                if (action === 'summarize') {
                    summarizePage();
                } else if (action === 'prompt') {
                    sendMessage(e.target.innerText);
                } else if (action === 'help') {
                    addMessage('ai', `I can help you understand and use this site. Try asking questions like:
                                      <ul><li><a href="#" data-action="prompt">What is this page about?</a></li>
                                          <li><a href="#" data-action="prompt">How do I use this feature?</a></li>
                                          <li><a href="#" data-action="prompt">Where can learn more?</a></li></ul>
                                      <a target="_blank" href="https://michaelwasserman.github.io/ai-examples/">InSite AI</a> uses on-device
                                      <a target="_blank" href="https://github.com/webmachinelearning/prompt-api">Prompt</a>,
                                      <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Summarizer_API">Summarizer</a>, and
                                      <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Translator_and_Language_Detector_APIs">Translator</a> AI models.`, true);
                }
            }
        });

        async function addMessage(sender, text, isHTML = false) {
            if (sender == 'ai' && translator) {
                text = await getTranslation(text);
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('ai-chat-message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            if (isHTML) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv;
        }

        function removeTypingIndicator(typingDiv) {
            if (typingDiv && typingDiv.parentNode) {
                chatMessages.removeChild(typingDiv);
            }
        }

        async function sendMessage(message = undefined) {
            message = message || chatInput.value.trim();
            if (!message) return;
            addMessage('user', message);
            chatInput.value = '';
            const typingDiv = showTypingIndicator();
            let response = "Sorry, I couldn't generate a response. Try Chrome Canary?";
            try {
                const prompt = `The user prompted: ${message}\n\nPlease provide a helpful response based on the page content and context, making the answer as concise as possible, 3 sentences or fewer.`;
                response = await languageModel.prompt(prompt);
            } catch (error) {
                console.error("Error generating response: ", error);
            } finally {
                addMessage('ai', response);
                removeTypingIndicator(typingDiv);
            }
        }

        async function getSummary(content = undefined) {
            try {
                content = content || await getPageContent();
                const context = 'You are a helpful AI assistant, tasked with providing concise 1-2 sentence summaries of a webpage, to be presented to a user in a small chat window on the page.';
                const summarizer = await Summarizer.create({length:'short', sharedContext: context});
                return await summarizer.summarize(content);
            } catch (error) {
                console.error("Error summarizing: ", error);
                return "Sorry, I couldn't generate a summary. Try Chrome Canary?";
            }
        }

        async function summarizePage() {
            const typingDiv = showTypingIndicator();
            addMessage('ai', await getSummary());
            removeTypingIndicator(typingDiv);
        }

        async function getTranslation(content) {
            if (!translator) return content;
            try {
                return await translator.translate(content);
            } catch (error) {
                console.error("Error translating: ", error);
                return `Sorry, I couldn't translate the text: "${content}". Try Chrome Canary?`;
            }
        }

        async function setLanguage(language) {
            const typingDiv = showTypingIndicator();
            translator = undefined;
            if (language && language != 'EN') {
                try {
                    translator = await Translator.create({sourceLanguage: 'en', targetLanguage: language});
                    chatInput.placeholder = await getTranslation("Ask me about this page...");
                } catch (error) {
                    console.error("Error creating translator: ", error);
                }
            }
            await addMessage('ai', `Language set to ${language}.`);
            removeTypingIndicator(typingDiv);
            initChat();
        }

        async function getPageContent() {
            const title = document.title;
            const mainContent = document.body.innerText.replace(/\s+/g, ' ').trim().substring(0, 5000); 
            const url = window.location.href;
            const metaDescription = document.querySelector('meta[name="description"]')?.content || '';
            return `Page Title: ${title}\nURL: ${url}\nDescription: ${metaDescription}\n\nMain Content:\n${mainContent}`;
        }

        function initChat() {
            // TODO: Restructure to avoid translating text with HTML tags :)
            let initialMessage = `Hello! I'm your AI assistant. I can <a href="#" data-action="summarize">summarize</a> this page or answer questions. How can I <a href="#" data-action="help">help</a>?`;
            addMessage('ai', initialMessage, true);
        }

        document.addEventListener('DOMContentLoaded', initChat);
    </script>
</body>
</html>
